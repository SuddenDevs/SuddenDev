{% extends "base.html" %}
{% block head %}
  <link rel="stylesheet" type="text/css" href="{{url_for('static', filename='style_game.css')}}">
  <script type="text/javascript" src="{{url_for('static', filename='createjs-2015.11.26.min.js')}}"></script>
  <script type="text/javascript" src="{{url_for('static', filename='src-min-noconflict/ace.js')}}"></script>
  <script>
      //Colors and static variables
      var ENEMYC = "#000000";
      var PICKUPC = "#edd95c";
      var COREC = "#47d7f7";
      var NAMEOFFS = 10;
      var EDITFONTSIZE = 15;
      var FRAMERATE = 60;
      var WAITTEXT = "Press ready to begin!";
      var MAXPLAYERS = 4;
      var EVENTS = {"CONNECT":'connect',"PLAYERID":'player_id',
                    "RESULT":'result',"UPDATE":'room_update',"TEST":'test',
                    "SUBMIT":'submit',"LEFT":'left',"JOINED":'joined',
                    "PLAY":'play'};

      var editor = null;
      var socket = null;
      var inGame = false;
      var playersLeft = 3;
      var currentTab = 0;
      var scripts = [`{{user.script}}`,"","",""];

      //Stage/shape drawer initialised, can be used in multiple functions
      var shape = null;
      var stage = null;
      var fpsText = null;
      var waitingText = null;
      var players = [];
      var playerNames = [];
      var playerID = -1;
      var playerCount = 1;

      //Game state
      var states = [];
      var statei = 0;

      //Initialise connection to server
      function initSocket() {
        $(document).ready(function(){
          socket = io.connect('http://' + document.domain + ':' + location.port + '/game-session');
          socket.on(EVENTS.CONNECT, function() {
            connectToGame();
          });
          socket.on(EVENTS.PLAYERID, function(data) {
            playerID = parseInt(data);
          });
          socket.on(EVENTS.RESULT, function(data) {
            readyGame(data);
          });
          socket.on(EVENTS.UPDATE, function(data) {
            updateRoom(data);
          });
        });
        window.onbeforeunload = function(e) {
            socket.emit(EVENTS.LEFT, {});
            socket.disconnect();
        }
      }

      //Tell the server when the player has joined
      function connectToGame() {
        socket.emit(EVENTS.JOINED, {});
      }

      //Function to start the game
      function readyGame(data) {
        states = JSON.parse(data).result;
        stage.removeChild(waitingText);
        for (i = 0; i < playerCount; i++) {
          stage.addChild(playerNames[i])
        }
        inGame = true;
      }

      //Update player details/scripts
      function updateRoom(data) {
        var room = JSON.parse(data);
        for (i = 0; i < playerNum; i++) {
          tryAddPlayer(room.players[i]);
          if (i != 0) {
            scripts[i] = players[i].script;
          }
        }
      }

      //If a player isn't already stored then store their details
      function tryAddPlayer(player) {
        if (havePlayer(player.id)) {
          return false;
        }
        players.push(player);
        var t = document.getElementById("tab" + str(playerCount));
        if (t.classList.contains("hidden")) {
          t.classList.remove("hidden");
        }
        var name = createjs.Text(player.name, "12px Arial", "x000000");
        playerNames.push(name);
        playerCount++;
        return true;
      }

      //Function to tell if a player id is already present in the room
      function havePlayer(id) {
        for (i = 0; i < players.length; i++) {
          if (players[i].id == id) {
            return true;
          }
        }
        return false;
      }

      //Tell server that the client is leaving
      function exitGame(e) {
        socket.emit(EVENTS.LEFT, {});
        socket.disconnect();
      }

      //Save the editor value in scripts
      function updateScripts() {
        scripts[currentTab] = editor.getValue();
      }

      function sendCode(event) {
        updateScripts();
        socket.emit(event, scripts[0]);
      }

      //Function to leave the game
      function leaveGame() {
        window.location.href = "{{ url_for('main.lobby') }}";
      }

      //Ready up
      function readyUp() {
        var b = document.getElementById("readyBtn");
        b.classList.add("active");
        b.classList.add("noEvents");
        socket.emit(EVENTS.PLAY, {});
      }

      //Initialise gameCanvas - initialise stage, add shape drawer
      function initCanvas() {
        stage = new createjs.Stage("gameCanvas");
        createjs.Ticker.framerate = FRAMERATE;
        createjs.Ticker.addEventListener("tick", handleTick);

        shape = new createjs.Shape();
        stage.addChild(shape);

        waitingText = new createjs.Text(WAITTEXT, "20px Arial", "x000000");
        waitingText.x = 400;
        waitingText.y = 200;
        waitingText.textAlign = "center";
        stage.addChild(waitingText);

        fpsText = new createjs.Text("", "20px Arial", "x000000");
        fpsText.x = 10;
        fpsText.y = 10;
        stage.addChild(fpsText);
        stage.update();
      }

      //Tick handler, clears graphics, draws FPS, updates canvas
      function handleTick(event) {
        if (!event.paused && inGame) {
          fpsText.text = createjs.Ticker.getMeasuredFPS();
          displayNextState();
        }
      }

      //Display the next state
      function displayNextState() {
        shape.graphics.clear();
        statei++;
        if (statei >= states.length) {
          statei = 0;
        }
        updateCanvas();
      }

      //Clear shape drawer, then draw game state to gameCanvas
      function updateCanvas() {
        var state = states[statei];
        drawPlayerList(state.players);
        drawList(state.enemies, ENEMYC);
        drawList(state.powerups, PICKUPC);
        shape.graphics.beginFill(COREC)
              .drawCircle(state.core.pos.x, state.core.pos.y, state.core.size);
        stage.update();
      }

      //Draws a triangle facing the direction of vector vel
      function drawTriangle(pos, vel, radius, color) {
        var angle = Math.atan2(vel.y, vel.x) * 180 / Math.PI;
        shape.graphics.beginFill(color).drawPolyStar(pos.x, pos.y, radius, 3, 0,
                                                      angle);
      }

      // Draw every object in a list the same color
      function drawList(list, color) {
        for (i = 0; i < list.length; i++) {
          drawTriangle(list[i].pos, list[i].vel, list[i].size, color);
        }
      }

      // Draw every player and update name locations
      function drawPlayerList(list) {
        for (i = 0; i < list.length; i++) {
          playerNames[i].x = list[i].pos.x + NAMEOFFS;
          playerNames[i].y = list[i].pos.y + NAMEOFFS;
          drawTriangle(list[i].pos, list[i].vel, list[i].size, list[i].color);
        }
      } 

      //Pause game, update pause button
      function togglePause() {
        createjs.Ticker.paused = !createjs.Ticker.paused;
        var b = document.getElementById("pauseBtn");
        b.innerHTML = (createjs.Ticker.paused) ? "Unpause" : "Pause";
        b.classList.toggle("active");
      }

      function setEditorTab(tabi) {
        var tabs = document.getElementsByClassName("tabBtn");
        tabs[currentTab].classList.toggle("active");
        tabs[tabi].classList.toggle("active");
        updateScripts();
        editor.setValue(scripts[tabi]);
        editor.focus();
        currentTab = tabi;
      }

      //Initialise the editor
      function initEditor() {
        editor = ace.edit("editor");
        editor.$blockScrolling = Infinity;
        editor.getSession().setMode("ace/mode/python");
        editor.getSession().setUseWrapMode(true);
        editor.setValue(scripts[0], 1);
      }

    </script>
{% endblock %}
{% block body %}
  
    <div id="title" class="title">
      <img src="{{ url_for('static', filename='logo_64.png')}}">
      <h1 id="heading" class="mainHeading">   S U D D E N _ D E V</h1>
    </div>
    <div class="container-fluid mainGrid">
      <div class="row mainRow">
        <div class="col mainCol gameCol">
          <div id="gameDiv" class="game greyBorder">
            <canvas id="gameCanvas" class="game" width="800px"
                    height="600px"></canvas>
            <div class="controls greyBorder">
              <button class="controls" onclick="leaveGame()">Leave Game</button>
              <button class="controls" onclick="displayNextState()">Next State
              <button class="controls" onclick="sendCode(SENDEVENTS.SUBMIT)">Save Code</button>
              <button id="readyBtn" class="controls" onclick="readyUp()">Ready</button>
              <button class="controls" onclick="sendCode(SENDEVENTS.TEST)">Test Code</button>
              <button id="pauseBtn" class="controls" onclick="togglePause()">Pause</button>
                </button>
            </div>
          </div>
        </div>
        <div class="col mainCol editCol">
          <div class="greyBorder">
            <div id="editor"></div>
          </div>
          <div class="controls">
            <button id="tab0" class="controls tabBtn active" 
                    onclick="setEditorTab(0)">Player1</button>
            <button id="tab1" class="controls tabBtn hidden" onclick="setEditorTab(1)">
                    Player2</button>
            <button id="tab2" class="controls tabBtn hidden" onclick="setEditorTab(2)">
                    Player3</button>
            <button id="tab3" class="controls tabBtn hidden" onclick="setEditorTab(3)">
                    Player4</button>
          </div>
        </div>
      </div>
      <div class="row detailRow">
        <div class="container-fluid detailGrid greyBorder">
          <div class="row detailRow">
            <div class="col-sm-8 detailCol">
            </div>
            <div class="col-sm-4 detailCol">
              <span style="width: 100%">Player1</span><br>
              <span style="width: 100%">Player2</span><br>
              <span style="width: 100%">Player3</span><br>
              <span style="width: 100%">Player4</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>initCanvas();initSocket();initEditor();</script>
{% endblock %}
  
